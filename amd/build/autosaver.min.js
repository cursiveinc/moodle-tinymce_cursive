define("tiny_cursive/autosaver",["exports","core/ajax","core/modal_factory","core/str","core/modal_events","jquery"],(function(_exports,_ajax,_modal_factory,_str,_modal_events,_jquery){var obj;Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.register=void 0,_jquery=(obj=_jquery)&&obj.__esModule?obj:{default:obj};_exports.register=(editor,interval,userId)=>{var _M$cfg$wwwroot,_M$cfg$courseId,isStudent=!(0,_jquery.default)("#body").hasClass("teacher_admin"),intervention=(0,_jquery.default)("#body").hasClass("intervention"),userid=userId,host=null!==(_M$cfg$wwwroot=M.cfg.wwwroot)&&void 0!==_M$cfg$wwwroot?_M$cfg$wwwroot:null,courseid=null!==(_M$cfg$courseId=M.cfg.courseId)&&void 0!==_M$cfg$courseId?_M$cfg$courseId:null,filename="",quizSubmit=(0,_jquery.default)("#mod_quiz-next-nav"),ed="",event="",recourceId=0,modulename="",editorid=null==editor?void 0:editor.id,cmid=M.cfg.contextInstanceId,questionid=0;let assignSubmit=(0,_jquery.default)("#id_submitbutton");var syncInterval=interval?1e3*interval:1e4;const postOne=async(methodname,args)=>{try{return await(0,_ajax.call)([{methodname:methodname,args:args}])[0]}catch(error){throw window.console.error("Error in postOne:",error),error}};assignSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{assignSubmit.off("click").click()})):assignSubmit.off("click").click()})),quizSubmit.on("click",(async function(e){e.preventDefault(),filename?syncData().then((()=>{quizSubmit.off("click").click()})):quizSubmit.off("click").click()}));const getModal=e=>(0,_modal_factory.create)({type:"SAVE_CANCEL",title:(0,_str.get_string)("tiny_cursive","tiny_cursive"),body:'<textarea  class="form-control inputUrl" value="" id="inputUrl" placeholder="sourceurl"></textarea>',removeOnClose:!0}).done((modal=>{modal.getRoot().append("<style>.close{ display: none ! important; }</style>"),modal.show();var lastEvent="";return modal.getRoot().on(_modal_events.save,(function(){var number=document.getElementById("inputUrl").value;""===number||null==number?(editor.execCommand("Undo"),alert("You cannot paste text without providing source")):editor.execCommand("Paste");let ur=e.srcElement.baseURI,recourceId=0,parm=new URL(ur),modulename="",editorid=null==editor?void 0:editor.id,courseid=M.cfg.courseId,cmid=M.cfg.contextInstanceId;if(!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;ur.includes("forum")||ur.includes("assign")||(recourceId=parm.searchParams.get("attempt")),null===recourceId&&(recourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign"),ur.includes("attempt")&&(modulename="quiz"),null===cmid&&(cmid=0),postOne("cursive_user_comments",{modulename:modulename,cmid:cmid,resourceid:recourceId,courseid:courseid,usercomment:number,timemodified:Date.now(),editorid:editorid||""}),lastEvent="save",modal.destroy()})),modal.getRoot().on(_modal_events.cancel,(function(){editor.execCommand("Undo"),lastEvent="cancel"})),modal.getRoot().on(_modal_events.hidden,(function(){"cancel"!=lastEvent&&"save"!=lastEvent&&editor.execCommand("Undo")})),modal})),sendKeyEvent=(events,eds)=>{let ur=eds.srcElement.baseURI,parm=new URL(ur);if(ed=eds,event=events,!(ur.includes("attempt.php")||ur.includes("forum")||ur.includes("assign")))return!1;if(ur.includes("forum")||ur.includes("assign")||(recourceId=parm.searchParams.get("attempt")),null===recourceId&&(recourceId=0),ur.includes("forum")&&(modulename="forum"),ur.includes("assign")&&(modulename="assign"),ur.includes("attempt")&&(modulename="quiz"),filename="".concat(userid,"_").concat(recourceId,"_").concat(cmid,"_").concat(modulename,"_attempt"),"quiz"===modulename&&(questionid=editorid.split(":")[1].split("_")[0],filename="".concat(userid,"_").concat(recourceId,"_").concat(cmid,"_").concat(questionid,"_").concat(modulename,"_attempt")),localStorage.getItem(filename)){let data=JSON.parse(localStorage.getItem(filename));data.push({resourceId:recourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}else{let data=[];data.push({resourceId:recourceId,key:ed.key,keyCode:ed.keyCode,event:event,courseId:courseid,unixTimestamp:Date.now(),clientId:host,personId:userid}),localStorage.setItem(filename,JSON.stringify(data))}};async function syncData(){let data=localStorage.getItem(filename);if(data&&0!==data.length){localStorage.removeItem(filename);try{return await postOne("cursive_write_local_to_json",{key:ed.key,event:event,keyCode:ed.keyCode,resourceId:recourceId,cmid:cmid,modulename:modulename,editorid:editorid,json_data:data})}catch(error){window.console.error("Error submitting data:",error)}}}editor.on("keyUp",(editor=>{sendKeyEvent("keyUp",editor)})),editor.on("Paste",(async e=>{isStudent&&intervention&&getModal(e)})),editor.on("Redo",(async e=>{isStudent&&intervention&&getModal(e)})),editor.on("keyDown",(editor=>{sendKeyEvent("keyDown",editor)})),editor.on("init",(()=>{})),window.addEventListener("unload",(()=>{syncData()})),setInterval(syncData,syncInterval)}}));

//# sourceMappingURL=autosaver.min.js.map