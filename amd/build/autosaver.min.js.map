{"version":3,"file":"autosaver.min.js","sources":["../src/autosaver.js"],"sourcesContent":["// This file is part of Moodle - http://moodle.org/\n//\n// Moodle is free software: you can redistribute it and/or modify\n// it under the terms of the GNU General Public License as published by\n// the Free Software Foundation, either version 3 of the License, or\n// (at your option) any later version.\n//\n// Moodle is distributed in the hope that it will be useful,\n// but WITHOUT ANY WARRANTY; without even the implied warranty of\n// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the\n// GNU General Public License for more details.\n//\n// You should have received a copy of the GNU General Public License\n// along with Moodle.  If not, see <http://www.gnu.org/licenses/>.\n\n/**\n * @module     tiny_cursive/autosaver\n * @category TinyMCE Editor\n * @copyright  CTI <info@cursivetechnology.com>\n * @author Brain Station 23 <elearning@brainstation-23.com>\n */\n\nimport { call } from 'core/ajax';\nimport { create } from 'core/modal_factory';\nimport { get_string as getString } from 'core/str';\nimport { save, cancel, hidden } from 'core/modal_events';\n\nexport const register = (editor, interval, userId) => {\n\n    var is_student, intervention, quizSubmit, assignSubmit;\n\n    quizSubmit = document.querySelector('#responseform');\n    assignSubmit = document.querySelector('#id_submitbutton');\n\n    var bodyElement = document.querySelector('#body');\n    if (bodyElement) {\n        is_student = !bodyElement.classList.contains('teacher_admin'); // true or false\n        intervention = bodyElement.classList.contains('intervention'); // true or false\n    } else {\n        console.error('#body element not found');\n    }\n\n\n    var userid = userId;\n    var host = M.cfg.wwwroot;\n    var courseid = M.cfg.courseId;\n    var filename = \"\";\n    var ed = \"\";\n    var event = \"\";\n    var resourceId = 0;\n    var modulename = \"\";\n    var editorid = editor?.id;\n    var cmid = M.cfg.contextInstanceId;\n    var questionid = 0;\n    var syncInterval = interval ? interval * 1000 : 10000; // Default: Sync Every 10s.\n\n    const postOne = async (methodname, args) => {\n        try {\n            const response = await call([{\n                methodname,\n                args,\n            }])[0];\n            return response;\n        } catch (error) {\n            console.error('Error in postOne:', error);\n            throw error;\n        }\n    };\n\n    if (document.getElementById('page-mod-assign-editsubmission') || document.getElementById('page-mod-forum-post') || document.getElementById('page-mod-forum-view')) {\n        if (assignSubmit) {\n            assignSubmit.addEventListener('click', async function (e) {\n                e.preventDefault();\n                if (filename) {\n                    await SyncData().then((res) => {\n                        assignSubmit.removeEventListener('click', arguments.callee);\n                        assignSubmit.click();\n                        assignSubmit.removeEventListener('click', arguments.callee);\n                    })\n                } else {\n                    assignSubmit.removeEventListener('click', arguments.callee);\n                    assignSubmit.click();\n                    assignSubmit.removeEventListener('click', arguments.callee);\n                }\n            });\n        }\n    }\n\n    if (document.getElementById('page-mod-quiz-attempt')) {\n        if (quizSubmit) {\n            quizSubmit.addEventListener('click', async (e) => {\n                if (filename) {\n                    await SyncData().then(res => {\n                        document.querySelector('#responseform').submit();\n                    });\n                }\n\n            });\n        }\n    }\n\n    const getModal = (e) => {\n\n        Promise.all([\n            getString('tiny_cursive_srcurl', 'tiny_cursive'),\n            getString('tiny_cursive_srcurl_des', 'tiny_cursive')\n        ]).then(function([title, titledes]) {\n\n            return create({\n                type: 'SAVE_CANCEL',\n                title: `<div><div style='color:dark;font-weight:500;line-height:0.5'>${title}</div><span style='color: gray;font-weight: 400;line-height: 1.2;font-size: 14px;display: inline-block;margin-top: .5rem;'>${titledes}</span></div>`,\n                body: '<textarea  class=\"form-control inputUrl\" value=\"\" id=\"inputUrl\" placeholder=\"Write your comment, links or informations here..\"></textarea>',\n    \n                removeOnClose: true,\n            })\n                .done(modal => {\n                    modal.getRoot().append('<style>.close{ display: none ! important; }</style>');\n                    modal.show();\n                    var lastEvent = '';\n                    // eslint-disable-next-line\n                    modal.getRoot().on(save, function() {\n                        var number = document.getElementById(\"inputUrl\").value;\n                        if (number === \"\" || number === null || number === undefined) {\n                            editor.execCommand('Undo');\n                            // eslint-disable-next-line\n                            alert(\"You cannot paste text without providing source\");\n                        } else {\n                            editor.execCommand('Paste');\n                        }\n                        let ur = e.srcElement.baseURI;\n                        let resourceId = 0;\n                        let parm = new URL(ur);\n                        let modulename = \"\";\n                        let editorid = editor?.id;\n                        let courseid = M.cfg.courseId;\n                        let cmid = M.cfg.contextInstanceId;\n    \n                        // eslint-disable-next-line\n                        if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n                            return false;\n                        }\n                        if (ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                            resourceId = parm.searchParams.get('edit');\n                        }\n                        if (!ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n                            resourceId = parm.searchParams.get('attempt');\n                        }\n    \n                        if (resourceId === null) {\n                            resourceId = 0;\n                        }\n                        if (ur.includes(\"forum\")) {\n                            modulename = \"forum\";\n                        }\n                        if (ur.includes(\"assign\")) {\n                            modulename = \"assign\";\n                            resourceId = cmid;\n                        }\n                        if (ur.includes(\"attempt\")) {\n                            modulename = \"quiz\";\n                        }\n                        if (cmid === null) {\n                            cmid = 0;\n                        }\n    \n                        postOne('cursive_user_comments', {\n                            modulename: modulename,\n                            cmid: cmid,\n                            resourceid: resourceId,\n                            courseid: courseid,\n                            usercomment: number,\n                            timemodified: Date.now(),\n                            editorid: editorid ? editorid : \"\"\n                        });\n                        lastEvent = 'save';\n                        modal.destroy();\n                    });\n                    modal.getRoot().on(cancel, function() {\n    \n                        editor.execCommand('Undo');\n                        lastEvent = 'cancel';\n                    });\n                    modal.getRoot().on(hidden, function() {\n                        if (lastEvent != 'cancel' && lastEvent != 'save') {\n                            editor.execCommand('Undo');\n                        }\n                    });\n                    return modal;\n                });\n        });\n        \n    };\n    const sendKeyEvent = (event, ed) => {\n        let ur = ed.srcElement.baseURI;\n        let parm = new URL(ur);\n        ed = ed;\n        event = event;\n\n        if (ur.includes(\"attempt.php\") || ur.includes(\"forum\") || ur.includes(\"assign\")) { } else {\n            return false;\n        }\n        if (ur.includes(\"forum\") && !ur.includes(\"assign\")) {\n            resourceId = parm.searchParams.get('edit');\n        } else {\n\n            resourceId = parm.searchParams.get('attempt');\n        }\n        if (resourceId === null) {\n\n            resourceId = 0;\n        }\n\n        if (ur.includes(\"forum\")) {\n            modulename = \"forum\";\n        }\n        if (ur.includes(\"assign\")) {\n            modulename = \"assign\";\n            resourceId = cmid;\n        }\n        if (ur.includes(\"attempt\")) {\n            modulename = \"quiz\";\n        }\n\n        filename = `${userid}_${resourceId}_${cmid}_${modulename}_attempt`;\n\n        if (modulename === 'quiz') {\n            questionid = editorid.split(':')[1].split('_')[0];\n            filename = `${userid}_${resourceId}_${cmid}_${questionid}_${modulename}_attempt`;\n        }\n        if (ed.key !== \"Process\") {\n            if (localStorage.getItem(filename)) {\n\n                let data = JSON.parse(localStorage.getItem(filename));\n                data.push({\n                    resourceId: resourceId,\n                    key: ed.key,\n                    keyCode: ed.keyCode,\n                    event: event,\n                    courseId: courseid,\n                    unixTimestamp: Date.now(),\n                    clientId: host,\n                    personId: userid\n                });\n                localStorage.setItem(filename, JSON.stringify(data));\n            } else {\n                let data = [];\n                data.push({\n                    resourceId: resourceId,\n                    key: ed.key,\n                    keyCode: ed.keyCode,\n                    event: event,\n                    courseId: courseid,\n                    unixTimestamp: Date.now(),\n                    clientId: host,\n                    personId: userid\n                });\n                localStorage.setItem(filename, JSON.stringify(data));\n            }\n        }\n    };\n    editor.on('keyUp', (editor) => {\n        sendKeyEvent(\"keyUp\", editor);\n    });\n    editor.on('Paste', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('Redo', async (e) => {\n        if (is_student && intervention) {\n            getModal(e);\n        }\n    });\n    editor.on('keyDown', (editor) => {\n        sendKeyEvent(\"keyDown\", editor);\n    });\n    editor.on('init', () => {\n\n    });\n\n    async function SyncData() {\n\n        let data = localStorage.getItem(filename);\n\n        if (!data || data.length === 0) {\n            return;\n        } else {\n            localStorage.removeItem(filename);\n            try {\n                return await postOne('cursive_write_local_to_json', {\n                    key: ed.key,\n                    event: event,\n                    keyCode: ed.keyCode,\n                    resourceId: resourceId,\n                    cmid: cmid,\n                    modulename: modulename,\n                    editorid: editorid,\n                    json_data: data,\n                });\n            } catch (error) {\n                console.error('Error submitting data:', error);\n            }\n        }\n    }\n\n    window.addEventListener('unload', (e) => {\n        SyncData();\n    });\n\n    setInterval(SyncData, syncInterval);\n};\n"],"names":["editor","interval","userId","is_student","intervention","quizSubmit","assignSubmit","document","querySelector","bodyElement","classList","contains","console","error","userid","host","M","cfg","wwwroot","courseid","courseId","filename","resourceId","modulename","editorid","id","cmid","contextInstanceId","questionid","syncInterval","postOne","async","methodname","args","getElementById","addEventListener","e","preventDefault","SyncData","then","res","removeEventListener","arguments","callee","click","submit","getModal","Promise","all","title","titledes","type","body","removeOnClose","done","modal","getRoot","append","show","lastEvent","on","save","number","value","execCommand","alert","ur","srcElement","baseURI","parm","URL","includes","searchParams","get","resourceid","usercomment","timemodified","Date","now","destroy","cancel","hidden","sendKeyEvent","event","ed","split","key","localStorage","getItem","data","JSON","parse","push","keyCode","unixTimestamp","clientId","personId","setItem","stringify","length","removeItem","json_data","window","setInterval"],"mappings":"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"}